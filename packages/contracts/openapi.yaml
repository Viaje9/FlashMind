openapi: 3.1.0
info:
  title: FlashMind API
  version: 0.1.0
  description: >
    Contracts for deck management, FSRS review workflow, AI-assisted content creation,
    and offline replay used by the FlashMind PWA.
servers:
  - url: https://api.flashmind.dev
paths:
  /decks:
    get:
      summary: List decks and aggregated stats
      operationId: listDecks
      parameters:
        - name: includeStats
          in: query
          schema:
            type: boolean
            default: true
      responses:
        "200":
          description: Deck collection
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeckListResponse'
    post:
      summary: Create deck
      operationId: createDeck
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDeckRequest'
      responses:
        "201":
          description: Deck created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Deck'
        "409":
          description: Deck name already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /decks/{deckId}:
    parameters:
      - $ref: '#/components/parameters/DeckIdParam'
    get:
      summary: Fetch deck details
      operationId: getDeck
      responses:
        "200":
          description: Deck detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Deck'
    patch:
      summary: Update deck settings
      operationId: updateDeck
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateDeckRequest'
      responses:
        "200":
          description: Updated deck
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Deck'
  /decks/{deckId}/cards:
    parameters:
      - $ref: '#/components/parameters/DeckIdParam'
    get:
      summary: List cards inside deck
      operationId: listCards
      parameters:
        - name: state
          in: query
          schema:
            type: string
            enum: [due, new, learning, all]
            default: all
      responses:
        "200":
          description: Card collection
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CardListResponse'
    post:
      summary: Create card with optional AI-generated content
      operationId: createCard
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCardRequest'
      responses:
        "201":
          description: Card created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Card'
  /cards/{cardId}:
    parameters:
      - name: cardId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    patch:
      summary: Update card content or senses
      operationId: updateCard
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCardRequest'
      responses:
        "200":
          description: Updated card
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Card'
  /reviews/due:
    get:
      summary: Retrieve next due cards for review session
      operationId: getDueCards
      parameters:
        - name: deckId
          in: query
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
      responses:
        "200":
          description: Due cards payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DueCardBatch'
  /reviews/batch:
    post:
      summary: Submit batched review logs (online or offline replay)
      operationId: submitReviewBatch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReviewBatchRequest'
      responses:
        "200":
          description: Review results including updated FSRS states
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewBatchResponse'
        "409":
          description: Conflict detected during replay
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConflictResponse'
  /sync/replay:
    post:
      summary: Replay anonymous logs after sign-in and merge with server authority
      operationId: replaySync
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReplayRequest'
      responses:
        "202":
          description: Merge scheduled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReplayResponse'
  /ai/generate-card:
    post:
      summary: Generate senses and examples for a term
      operationId: generateCardAI
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateCardRequest'
      responses:
        "200":
          description: AI produced content
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerateCardResponse'
        "503":
          description: AI generation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /ai/rewrite-example:
    post:
      summary: Rewrite a specific example sentence
      operationId: rewriteExampleAI
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RewriteExampleRequest'
      responses:
        "200":
          description: Revised example
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RewriteExampleResponse'
components:
  parameters:
    DeckIdParam:
      name: deckId
      in: path
      required: true
      schema:
        type: string
        format: uuid
  schemas:
    DeckListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Deck'
    Deck:
      type: object
      required: [id, name, dailyNewLimit, stats, version]
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string
        ownerType:
          type: string
          enum: [user, device]
        dailyNewLimit:
          type: integer
          minimum: 1
          maximum: 50
        reviewOrder:
          type: string
          enum: [due-first, new-first, mixed]
        stats:
          $ref: '#/components/schemas/DeckStats'
        version:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    DeckStats:
      type: object
      properties:
        dueToday:
          type: integer
        newCount:
          type: integer
        completionRate:
          type: number
          format: float
        estimatedMinutes:
          type: number
          format: float
    CreateDeckRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        dailyNewLimit:
          type: integer
          minimum: 1
          maximum: 50
        reviewOrder:
          type: string
          enum: [due-first, new-first, mixed]
    UpdateDeckRequest:
      type: object
      properties:
        name:
          type: string
        dailyNewLimit:
          type: integer
          minimum: 1
          maximum: 50
        reviewOrder:
          type: string
          enum: [due-first, new-first, mixed]
    CardListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Card'
    Card:
      type: object
      required: [id, term, senses, state, version]
      properties:
        id:
          type: string
          format: uuid
        deckId:
          type: string
          format: uuid
        term:
          type: string
        notes:
          type: string
          nullable: true
        senses:
          type: array
          items:
            $ref: '#/components/schemas/CardSense'
        tags:
          type: array
          items:
            type: string
        state:
          $ref: '#/components/schemas/CardState'
        version:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    CardSense:
      type: object
      required: [meaning, exampleEn, exampleZh, source]
      properties:
        id:
          type: string
        meaning:
          type: string
        exampleEn:
          type: string
        exampleZh:
          type: string
        source:
          type: string
          enum: [ai, manual]
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
        revisions:
          type: array
          items:
            type: object
            properties:
              reason:
                type: string
              updatedAt:
                type: string
                format: date-time
    CardState:
      type: object
      required: [due, stability, difficulty, authority]
      properties:
        due:
          type: string
          format: date
        stability:
          type: number
          format: float
        difficulty:
          type: number
          format: float
        elapsedDays:
          type: integer
        scheduledDays:
          type: integer
        lastReviewedAt:
          type: string
          format: date-time
          nullable: true
        lastRating:
          type: string
          enum: [again, hard, easy, none]
        authority:
          type: string
          enum: [local, server]
    CreateCardRequest:
      type: object
      required: [term]
      properties:
        term:
          type: string
        notes:
          type: string
        senses:
          type: array
          items:
            $ref: '#/components/schemas/CardSenseInput'
        aiContext:
          type: object
          properties:
            requestId:
              type: string
            model:
              type: string
              default: gemini-2.5-flash
    UpdateCardRequest:
      type: object
      properties:
        term:
          type: string
        notes:
          type: string
        senses:
          type: array
          items:
            $ref: '#/components/schemas/CardSenseInput'
        tags:
          type: array
          items:
            type: string
    CardSenseInput:
      type: object
      required: [meaning]
      properties:
        meaning:
          type: string
        exampleEn:
          type: string
        exampleZh:
          type: string
        source:
          type: string
          enum: [ai, manual]
        confidence:
          type: number
          format: float
        preservePrevious:
          type: boolean
    DueCardBatch:
      type: object
      required: [deckId, cards]
      properties:
        deckId:
          type: string
          format: uuid
        cards:
          type: array
          items:
            $ref: '#/components/schemas/Card'
        sessionId:
          type: string
          format: uuid
        generatedAt:
          type: string
          format: date-time
    ReviewBatchRequest:
      type: object
      required: [deviceId, logs]
      properties:
        deviceId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
          nullable: true
        sessionId:
          type: string
          format: uuid
        logs:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/ReviewLogInput'
    ReviewLogInput:
      type: object
      required: [cardId, rating, reviewedAt, sequence]
      properties:
        cardId:
          type: string
          format: uuid
        rating:
          type: string
          enum: [again, hard, easy]
        reviewedAt:
          type: string
          format: date-time
        sequence:
          type: integer
        elapsedSeconds:
          type: number
          format: float
        authority:
          type: string
          enum: [local, server]
    ReviewBatchResponse:
      type: object
      properties:
        updatedStates:
          type: array
          items:
            $ref: '#/components/schemas/CardState'
        conflicts:
          type: array
          items:
            $ref: '#/components/schemas/ConflictEntry'
        nextDue:
          type: array
          items:
            $ref: '#/components/schemas/Card'
    ConflictEntry:
      type: object
      properties:
        cardId:
          type: string
        reason:
          type: string
        serverLog:
          $ref: '#/components/schemas/ReviewLogOutput'
    ConflictResponse:
      type: object
      required: [error, conflicts]
      properties:
        error:
          $ref: '#/components/schemas/ErrorResponse'
        conflicts:
          type: array
          items:
            $ref: '#/components/schemas/ConflictEntry'
    ReviewLogOutput:
      type: object
      properties:
        cardId:
          type: string
        rating:
          type: string
        reviewedAt:
          type: string
          format: date-time
        sequence:
          type: integer
    ReplayRequest:
      type: object
      required: [deviceId, userId]
      properties:
        deviceId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        maxEvents:
          type: integer
          default: 1000
    ReplayResponse:
      type: object
      properties:
        accepted:
          type: integer
        conflicts:
          type: integer
        scheduledAt:
          type: string
          format: date-time
    GenerateCardRequest:
      type: object
      required: [term]
      properties:
        term:
          type: string
        deckContext:
          type: string
        language:
          type: string
          default: en
        maxSenses:
          type: integer
          default: 3
    GenerateCardResponse:
      type: object
      properties:
        requestId:
          type: string
        senses:
          type: array
          items:
            $ref: '#/components/schemas/CardSense'
        cached:
          type: boolean
    RewriteExampleRequest:
      type: object
      required: [term, example]
      properties:
        term:
          type: string
        example:
          type: string
        style:
          type: string
          enum: [casual, formal, academic]
        tone:
          type: string
          enum: [friendly, neutral, serious]
    RewriteExampleResponse:
      type: object
      properties:
        revisedExample:
          type: string
        rationale:
          type: string
    ErrorResponse:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
        message:
          type: string
