openapi: 3.0.3
info:
  title: FlashMind API
  version: 0.1.0
  description: |
    FlashMind API 契約

    ## 設計規範
    - Response 格式：統一 Wrapper `{ data, meta? }`
    - Error 格式：`{ error: { code, message } }`
    - 認證方式：HttpOnly Cookie
    - 詳見 ADR-016

servers:
  - url: https://api.flashmind.local

paths:
  # ============================================================
  # Auth
  # ============================================================
  /auth/register:
    post:
      operationId: register
      tags:
        - Auth
      summary: 註冊帳號
      description: 使用 Email 註冊新帳號，成功後設定 session cookie。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: 註冊成功
          headers:
            Set-Cookie:
              description: Session cookie
              schema:
                type: string
                example: session=abc123; HttpOnly; Secure; SameSite=Strict; Path=/
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          description: 輸入資料不完整或格式錯誤
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: VALIDATION_ERROR
                  message: 密碼至少需要 8 個字元
        "409":
          description: Email 已被使用
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: AUTH_EMAIL_ALREADY_EXISTS
                  message: 此 Email 已被註冊

  /auth/login:
    post:
      operationId: login
      tags:
        - Auth
      summary: 登入帳號
      description: 使用 Email + 密碼登入，成功後設定 session cookie。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: 登入成功
          headers:
            Set-Cookie:
              description: Session cookie
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          description: 輸入資料不完整或格式錯誤
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: 帳密錯誤
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: AUTH_INVALID_CREDENTIALS
                  message: Email 或密碼錯誤

  /auth/logout:
    post:
      operationId: logout
      tags:
        - Auth
      summary: 登出帳號
      description: 撤銷目前 session 並清除 cookie。
      security:
        - cookieAuth: []
      responses:
        "204":
          description: 登出成功
          headers:
            Set-Cookie:
              description: 清除 session cookie
              schema:
                type: string
                example: session=; HttpOnly; Secure; SameSite=Strict; Path=/; Max-Age=0
        "401":
          description: 未授權
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: UNAUTHORIZED
                  message: 請先登入

  /auth/google:
    get:
      operationId: initiateGoogleOAuth
      tags:
        - Auth
      summary: 發起 Google OAuth
      description: 重新導向至 Google 授權頁面。
      parameters:
        - name: rememberMe
          in: query
          description: 是否記住登入狀態
          schema:
            type: boolean
            default: false
      responses:
        "302":
          description: 重新導向至 Google 授權頁面
          headers:
            Location:
              description: Google OAuth 授權 URL
              schema:
                type: string

  /auth/google/callback:
    get:
      operationId: handleGoogleOAuthCallback
      tags:
        - Auth
      summary: Google OAuth Callback
      description: Google 授權完成後的回呼端點，驗證後設定 session cookie 並導向前端。
      parameters:
        - name: code
          in: query
          required: true
          description: Google 授權碼
          schema:
            type: string
        - name: state
          in: query
          description: 狀態參數（含 rememberMe 等資訊）
          schema:
            type: string
      responses:
        "302":
          description: 登入成功，導向前端主頁
          headers:
            Location:
              description: 前端主頁 URL
              schema:
                type: string
            Set-Cookie:
              description: Session cookie
              schema:
                type: string
        "401":
          description: Google 授權失敗
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: AUTH_GOOGLE_FAILED
                  message: Google 登入失敗，請重試

  /auth/me:
    get:
      operationId: getCurrentUser
      tags:
        - Auth
      summary: 取得目前使用者資訊
      description: 取得目前登入使用者的資訊。
      security:
        - cookieAuth: []
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "401":
          description: 未授權
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: UNAUTHORIZED
                  message: 請先登入

  # ============================================================
  # Decks
  # ============================================================
  /decks:
    get:
      operationId: listDecks
      tags:
        - Decks
      summary: 取得牌組列表
      description: 取得目前使用者的所有牌組列表，包含學習統計資訊。
      security:
        - cookieAuth: []
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeckListResponse"
        "401":
          description: 未授權
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    post:
      operationId: createDeck
      tags:
        - Decks
      summary: 建立新牌組
      description: 建立新牌組，成功後返回牌組資訊。
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateDeckRequest"
      responses:
        "201":
          description: 建立成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeckResponse"
        "400":
          description: 輸入資料不完整或格式錯誤
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: VALIDATION_ERROR
                  message: 請輸入牌組名稱
        "401":
          description: 未授權
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /decks/{id}:
    get:
      operationId: getDeck
      tags:
        - Decks
      summary: 取得牌組詳情
      description: 取得指定牌組的詳細資訊，包含學習統計。
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 牌組 ID
          schema:
            type: string
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeckDetailResponse"
        "401":
          description: 未授權
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: 無權限存取此牌組
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: FORBIDDEN
                  message: 無權限存取此牌組
        "404":
          description: 牌組不存在
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  code: DECK_NOT_FOUND
                  message: 找不到此牌組

    patch:
      operationId: updateDeck
      tags:
        - Decks
      summary: 更新牌組設定
      description: 更新指定牌組的設定。
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 牌組 ID
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateDeckRequest"
      responses:
        "200":
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeckResponse"
        "400":
          description: 輸入資料格式錯誤
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: 未授權
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: 無權限修改此牌組
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: 牌組不存在
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    delete:
      operationId: deleteDeck
      tags:
        - Decks
      summary: 刪除牌組
      description: 刪除指定牌組及其所有卡片和學習紀錄。
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 牌組 ID
          schema:
            type: string
      responses:
        "204":
          description: 刪除成功
        "401":
          description: 未授權
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: 無權限刪除此牌組
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: 牌組不存在
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: session
      description: HttpOnly session cookie

  schemas:
    # ============================================================
    # Common
    # ============================================================
    ErrorResponse:
      type: object
      description: 錯誤回應（符合 ADR-016）
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: 機器可讀的錯誤碼（SCREAMING_SNAKE_CASE）
              example: AUTH_INVALID_CREDENTIALS
            message:
              type: string
              description: 使用者可讀的錯誤訊息
              example: Email 或密碼錯誤

    PaginationMeta:
      type: object
      description: 分頁資訊（cursor-based）
      properties:
        nextCursor:
          type: string
          nullable: true
          description: 下一頁的 cursor，若無更多資料則為 null
        hasMore:
          type: boolean
          description: 是否還有更多資料

    # ============================================================
    # Auth
    # ============================================================
    RegisterRequest:
      type: object
      description: Email 註冊請求
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          minLength: 8
          description: 密碼（至少 8 字元）
          example: securepassword123

    LoginRequest:
      type: object
      description: Email 登入請求
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          minLength: 8
          example: securepassword123
        rememberMe:
          type: boolean
          default: false
          description: 記住我（延長 session 效期至 30 天）

    User:
      type: object
      description: 使用者資料
      required:
        - id
        - email
        - primaryProvider
        - createdAt
      properties:
        id:
          type: string
          description: 使用者 ID（cuid）
          example: clh1234567890abcdef
        email:
          type: string
          format: email
          example: user@example.com
        primaryProvider:
          type: string
          enum: [email, google]
          description: 主要登入方式
        createdAt:
          type: string
          format: date-time
          description: 建立時間（ISO 8601 UTC）
          example: "2026-01-17T10:30:00Z"
        lastLoginAt:
          type: string
          format: date-time
          nullable: true
          description: 最後登入時間
          example: "2026-01-17T14:45:30Z"

    UserResponse:
      type: object
      description: 使用者回應（符合 ADR-016 統一 Wrapper）
      required:
        - data
      properties:
        data:
          $ref: "#/components/schemas/User"

    # ============================================================
    # Decks
    # ============================================================
    Deck:
      type: object
      description: 牌組資料
      required:
        - id
        - name
        - dailyNewCards
        - dailyReviewCards
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          description: 牌組 ID（cuid）
          example: clh1234567890abcdef
        name:
          type: string
          description: 牌組名稱
          maxLength: 100
          example: 英文單字
        dailyNewCards:
          type: integer
          description: 每日新卡數
          minimum: 5
          maximum: 100
          default: 20
          example: 20
        dailyReviewCards:
          type: integer
          description: 每日複習數
          minimum: 10
          maximum: 500
          default: 100
          example: 100
        createdAt:
          type: string
          format: date-time
          description: 建立時間（ISO 8601 UTC）
          example: "2026-01-17T10:30:00Z"
        updatedAt:
          type: string
          format: date-time
          description: 更新時間（ISO 8601 UTC）
          example: "2026-01-17T14:45:30Z"

    DeckListItem:
      type: object
      description: 牌組列表項目（含學習統計）
      required:
        - id
        - name
        - newCount
        - reviewCount
        - totalCount
        - completedCount
        - progress
      properties:
        id:
          type: string
          description: 牌組 ID
          example: clh1234567890abcdef
        name:
          type: string
          description: 牌組名稱
          example: 英文單字
        newCount:
          type: integer
          description: 今日可學習新卡數
          example: 10
        reviewCount:
          type: integer
          description: 今日待複習數
          example: 25
        totalCount:
          type: integer
          description: 總卡片數
          example: 100
        completedCount:
          type: integer
          description: 已完成學習的卡片數
          example: 65
        progress:
          type: number
          format: float
          description: 學習進度百分比（0-100）
          minimum: 0
          maximum: 100
          example: 65.0

    DeckDetail:
      type: object
      description: 牌組詳情（含學習統計）
      required:
        - id
        - name
        - dailyNewCards
        - dailyReviewCards
        - stats
      properties:
        id:
          type: string
          description: 牌組 ID
          example: clh1234567890abcdef
        name:
          type: string
          description: 牌組名稱
          example: 英文單字
        dailyNewCards:
          type: integer
          description: 每日新卡數
          example: 20
        dailyReviewCards:
          type: integer
          description: 每日複習數
          example: 100
        stats:
          $ref: "#/components/schemas/DeckStats"

    DeckStats:
      type: object
      description: 牌組學習統計
      required:
        - newCount
        - reviewCount
        - totalCount
        - createdAt
      properties:
        newCount:
          type: integer
          description: 今日可學習新卡數
          example: 10
        reviewCount:
          type: integer
          description: 今日待複習數
          example: 25
        totalCount:
          type: integer
          description: 總卡片數
          example: 100
        createdAt:
          type: string
          format: date-time
          description: 牌組建立時間
          example: "2026-01-17T10:30:00Z"
        lastStudiedAt:
          type: string
          format: date-time
          nullable: true
          description: 上次學習時間
          example: "2026-01-17T14:45:30Z"

    CreateDeckRequest:
      type: object
      description: 建立牌組請求
      required:
        - name
      properties:
        name:
          type: string
          description: 牌組名稱（必填）
          maxLength: 100
          example: 英文單字
        dailyNewCards:
          type: integer
          description: 每日新卡數（預設 20）
          minimum: 5
          maximum: 100
          default: 20
          example: 20
        dailyReviewCards:
          type: integer
          description: 每日複習數（預設 100）
          minimum: 10
          maximum: 500
          default: 100
          example: 100

    UpdateDeckRequest:
      type: object
      description: 更新牌組請求
      properties:
        name:
          type: string
          description: 牌組名稱
          maxLength: 100
          example: 英文單字
        dailyNewCards:
          type: integer
          description: 每日新卡數
          minimum: 5
          maximum: 100
          example: 20
        dailyReviewCards:
          type: integer
          description: 每日複習數
          minimum: 10
          maximum: 500
          example: 100

    DeckResponse:
      type: object
      description: 牌組回應（符合 ADR-016 統一 Wrapper）
      required:
        - data
      properties:
        data:
          $ref: "#/components/schemas/Deck"

    DeckListResponse:
      type: object
      description: 牌組列表回應
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/DeckListItem"

    DeckDetailResponse:
      type: object
      description: 牌組詳情回應
      required:
        - data
      properties:
        data:
          $ref: "#/components/schemas/DeckDetail"
