<div class="min-h-screen pb-24">
  <fm-page-header title="" layout="center">
    <fm-icon-button
      class="fm-header-left"
      variant="ghost"
      ariaLabel="返回"
      routerLink="/decks"
      testId="deck-detail-back"
    >
      <span class="material-symbols-outlined text-[22px]">arrow_back</span>
    </fm-icon-button>
    <fm-icon-button
      class="fm-header-right"
      variant="ghost"
      ariaLabel="匯入"
      [routerLink]="['/decks', deckId(), 'cards', 'import']"
      testId="deck-detail-import"
    >
      <span class="material-symbols-outlined text-[22px]">upload</span>
    </fm-icon-button>
    <fm-icon-button
      class="fm-header-right"
      variant="ghost"
      ariaLabel="設定"
      [routerLink]="['/decks', deckId(), 'settings']"
      testId="deck-detail-settings"
    >
      <span class="material-symbols-outlined text-[22px]">settings</span>
    </fm-icon-button>
  </fm-page-header>

  <main class="mx-auto w-full max-w-md px-4 pt-4 space-y-4">
    @if (deck(); as d) {
      <fm-deck-stats-card
        [deckName]="d.name"
        [newCount]="d.stats.newCount"
        [reviewCount]="d.stats.reviewCount"
        [enableReverse]="d.enableReverse ?? false"
        [createdAtLabel]="formatDate(d.stats.createdAt)"
        [lastReviewLabel]="formatLastStudied(d.stats.lastStudiedAt)"
        [actionLabel]="hasStudyItems() ? '開始學習' : '無待學習'"
        [actionDisabled]="!hasStudyItems()"
        [dailyNewCards]="studySummary()?.dailyNewCards ?? 0"
        [dailyReviewCards]="studySummary()?.dailyReviewCards ?? 0"
        [todayNewStudied]="studySummary()?.todayNewStudied ?? 0"
        [todayReviewStudied]="studySummary()?.todayReviewStudied ?? 0"
        [overrideActive]="overrideActive()"
        (actionClick)="onStartStudy()"
        (overrideClick)="onOverrideClick()"
        testId="deck-detail-stats"
      ></fm-deck-stats-card>
    }

    @if (!isEmpty()) {
      <div class="flex items-center gap-2" data-testid="deck-detail-search-filter-row">
        <div class="min-w-0 flex-1">
          <fm-search-input
            [formControl]="searchControl"
            placeholder="搜尋牌組內的卡片..."
            ariaLabel="搜尋牌組內的卡片"
            testId="deck-detail-search"
          ></fm-search-input>
        </div>
        <div class="w-36 shrink-0">
          <label
            for="deck-detail-filter"
            class="mb-1 block text-xs font-medium text-slate-500 dark:text-slate-300"
            >Filter</label
          >
          <select
            id="deck-detail-filter"
            [formControl]="filterControl"
            class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:border-primary focus:outline-none dark:border-white/10 dark:bg-slate-900"
            data-testid="deck-detail-filter"
          >
            @for (option of filterOptions; track option.value) {
              <option [value]="option.value">{{ option.label }}</option>
            }
          </select>
        </div>
      </div>

      <div class="flex flex-col gap-3 pb-6">
        @for (card of filteredCards(); track card.id) {
          <fm-card-list-item
            [title]="card.front"
            [description]="card.summary"
            [state]="card.state"
            [due]="card.due ?? null"
            (editClick)="onEditCard(card.id)"
            (deleteClick)="onDeleteCard(card)"
            [testId]="'deck-detail-card-' + card.id"
          ></fm-card-list-item>
        }
      </div>
    } @else {
      <fm-empty-state
        title="尚無卡片"
        description="點擊右下角的「+」按鈕新增你的第一張卡片"
        icon="style"
        testId="deck-detail-empty"
      ></fm-empty-state>
    }
  </main>

  <div class="fixed bottom-6 right-6 z-20">
    <fm-fab
      ariaLabel="新增卡片"
      [routerLink]="['/decks', deckId(), 'cards', 'new']"
      testId="deck-detail-add-card"
    >
      <span class="material-symbols-outlined text-[28px]">add</span>
    </fm-fab>
  </div>
</div>
