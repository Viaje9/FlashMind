<div class="min-h-screen bg-slate-50 pb-8">
  @if (!selectedConversationId()) {
    <fm-page-header title="口說歷史" layout="center">
      <fm-button class="fm-header-left" variant="ghost" size="sm" routerLink="/speaking">
        <span class="material-symbols-outlined text-[20px]">chevron_left</span>
        返回
      </fm-button>
    </fm-page-header>

    <main class="mx-auto w-full max-w-3xl px-4 pt-4">
      @if (loading()) {
        <div class="rounded-xl border border-slate-200 bg-white p-4 text-sm text-slate-500">
          讀取歷史中...
        </div>
      }

      @if (!loading() && conversations().length === 0) {
        <div
          class="rounded-2xl border border-dashed border-slate-300 bg-slate-50 p-5 text-sm text-slate-500"
        >
          目前還沒有口說歷史。先到口說頁送出第一段錄音吧。
        </div>
      }

      @if (!loading() && conversations().length > 0) {
        <ul class="space-y-3" data-testid="speaking-history-list">
          @for (conversation of conversations(); track conversation.id) {
            <li class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
              <button
                type="button"
                class="w-full text-left"
                (click)="openConversation(conversation.id)"
                data-testid="speaking-history-item"
              >
                <div class="mb-2 flex items-center justify-between gap-3">
                  <p class="font-semibold text-slate-900">{{ conversation.title || '新對話' }}</p>
                  <span class="text-xs text-slate-400">{{
                    formatUpdatedAt(conversation.updatedAt)
                  }}</span>
                </div>

                <p class="line-clamp-2 text-sm text-slate-500">
                  {{ conversation.summary || conversation.lastMessageText || '（無文字摘要）' }}
                </p>

                <p class="mt-2 text-xs text-slate-400">共 {{ conversation.messageCount }} 則訊息</p>
              </button>

              <div class="mt-3 flex items-center justify-end gap-3">
                <button
                  type="button"
                  class="text-xs text-slate-500 underline"
                  [disabled]="!conversation.summary?.trim()"
                  (click)="copySummary(conversation)"
                >
                  {{ copiedConversationId() === conversation.id ? '已複製摘要' : '複製摘要' }}
                </button>

                <button
                  type="button"
                  class="text-xs text-rose-500 underline"
                  [disabled]="deletingId() === conversation.id"
                  (click)="requestDeleteConversation(conversation.id)"
                  data-testid="speaking-history-delete"
                >
                  @if (deletingId() === conversation.id) {
                    刪除中...
                  } @else {
                    刪除
                  }
                </button>
              </div>
            </li>
          }
        </ul>
      }
    </main>
  } @else {
    <fm-page-header title="對話詳情" layout="center">
      <fm-button class="fm-header-left" variant="ghost" size="sm" (click)="closeDetail()">
        <span class="material-symbols-outlined text-[20px]">chevron_left</span>
        返回
      </fm-button>
    </fm-page-header>

    <main class="mx-auto flex w-full max-w-3xl flex-1 flex-col px-4 pt-4">
      @if (loadingDetail()) {
        <div class="rounded-xl border border-slate-200 bg-white p-4 text-sm text-slate-500">
          讀取對話中...
        </div>
      } @else {
        @if (selectedConversation?.summary) {
          <article
            class="mb-3 rounded-2xl border border-orange-200 bg-orange-50 px-4 py-3 shadow-sm"
          >
            <div class="mb-2 flex items-center gap-2 text-xs font-semibold text-orange-600">
              <span class="material-symbols-outlined text-[15px]">description</span>
              對話摘要
            </div>
            <p class="whitespace-pre-wrap text-sm leading-relaxed text-slate-700">
              {{ selectedConversation?.summary }}
            </p>
          </article>
        }

        @if (detailMessages().length === 0) {
          <div
            class="rounded-2xl border border-dashed border-slate-300 bg-slate-50 p-5 text-sm text-slate-500"
          >
            此對話暫無可顯示訊息。
          </div>
        }

        <section class="space-y-3">
          @for (message of detailMessages(); track message.id) {
            @if (message.role === 'summary') {
              <article
                class="rounded-2xl border border-orange-200 bg-orange-50 px-4 py-3 shadow-sm"
              >
                <p class="whitespace-pre-wrap text-sm leading-relaxed text-slate-700">
                  {{ message.text }}
                </p>
              </article>
            } @else {
              <article
                class="flex"
                [class.justify-end]="message.role === 'user'"
                [class.justify-start]="message.role === 'assistant'"
              >
                <div
                  class="max-w-[78%] rounded-2xl px-4 py-2.5 shadow-sm"
                  [class.rounded-br-md]="message.role === 'user'"
                  [class.bg-primary]="message.role === 'user'"
                  [class.text-white]="message.role === 'user'"
                  [class.rounded-bl-md]="message.role === 'assistant'"
                  [class.bg-white]="message.role === 'assistant'"
                  [class.ring-1]="message.role === 'assistant'"
                  [class.ring-slate-200]="message.role === 'assistant'"
                >
                  <p
                    class="whitespace-pre-wrap text-sm leading-relaxed"
                    [class.text-slate-700]="message.role === 'assistant'"
                  >
                    {{ message.text || '（語音訊息）' }}
                  </p>
                </div>
              </article>
            }
          }
        </section>
      }
    </main>

    <footer
      class="sticky bottom-0 mt-4 border-t border-slate-100 bg-white/95 px-4 py-3 backdrop-blur-sm"
    >
      <div class="mx-auto w-full max-w-3xl">
        <fm-button [fullWidth]="true" (click)="continueConversation()">繼續對話</fm-button>
      </div>
    </footer>
  }

  @if (pendingDeleteConversationId()) {
    <div class="fixed inset-0 z-[100] flex items-center justify-center bg-black/35 px-4">
      <div class="w-full max-w-sm rounded-2xl bg-white p-5 shadow-xl ring-1 ring-slate-200">
        <h3 class="text-base font-semibold text-slate-900">確認刪除</h3>
        <p class="mt-2 text-sm leading-relaxed text-slate-500">
          刪除聊天記錄時，會把歷史資料一併刪除。
        </p>
        <div class="mt-4 flex justify-end gap-2">
          <button
            type="button"
            class="rounded-lg px-3 py-2 text-sm text-slate-500 hover:bg-slate-50"
            (click)="cancelDeleteConversation()"
          >
            取消
          </button>
          <button
            type="button"
            class="rounded-lg bg-rose-500 px-3 py-2 text-sm text-white hover:bg-rose-600"
            (click)="confirmDeleteConversation()"
          >
            刪除
          </button>
        </div>
      </div>
    </div>
  }
</div>
