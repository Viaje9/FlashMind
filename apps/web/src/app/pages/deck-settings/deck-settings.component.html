<div class="min-h-screen pb-6">
  <fm-page-header title="牌組設定">
    <fm-icon-button class="fm-header-left" variant="ghost" ariaLabel="返回" [routerLink]="['/decks', deckId()]">
      <span class="material-symbols-outlined text-[22px]">arrow_back</span>
    </fm-icon-button>
  </fm-page-header>

  <main class="mx-auto w-full max-w-md px-4 pt-4">
    @if (isLoading()) {
      <div class="flex justify-center py-8">
        <span class="text-slate-400">載入中...</span>
      </div>
    } @else {
      <form class="flex flex-col gap-6">
        <fm-labeled-input
          [formControl]="deckNameControl"
          label="牌組名稱"
          icon="style"
          placeholder="例如：日文 N5 單字"
          ariaLabel="牌組名稱"
        ></fm-labeled-input>

        <div class="flex flex-col gap-4">
          <fm-section-heading text="每日限制"></fm-section-heading>

          <fm-number-input-row
            [formControl]="dailyNewCardsControl"
            label="每日新卡數"
            title="新學習"
            description="建議初學者設定 20 張"
            icon="library_add"
            iconClass="bg-blue-500/10 text-blue-500"
            [min]="5"
            [max]="100"
            [step]="5"
            unit="張"
            ariaLabel="每日新卡數"
          ></fm-number-input-row>

          <fm-number-input-row
            [formControl]="dailyReviewCardsControl"
            label="每日複習數"
            title="複習上限"
            description="包含舊卡片複習"
            icon="history"
            iconClass="bg-amber-500/10 text-amber-500"
            [min]="10"
            [max]="500"
            [step]="10"
            unit="張"
            ariaLabel="每日複習數"
          ></fm-number-input-row>

          <fm-number-input-row
            [formControl]="dailyResetHourControl"
            label="每日重置時間"
            title="學習日起始"
            description="每天此時重置學習額度"
            icon="schedule"
            iconClass="bg-emerald-500/10 text-emerald-500"
            [min]="0"
            [max]="23"
            [step]="1"
            unit="時"
            ariaLabel="每日重置時間"
          ></fm-number-input-row>
        </div>

        <p class="text-xs leading-relaxed text-slate-400 dark:text-slate-500">
          提示：較高的每日新卡數可能會導致未來的複習量大幅增加。新設定將於下次學習時生效。
        </p>

        <!-- 反向學習設定 -->
        <div class="flex flex-col gap-4">
          <fm-section-heading text="反向學習"></fm-section-heading>

          <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50 dark:bg-card-dark">
            <div class="flex-1 pr-3">
              <div class="text-sm font-medium text-slate-900 dark:text-white">啟用反向學習</div>
              <div class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">學習時也會出現中文翻譯作為提示，要求回答英文</div>
            </div>
            <button
              type="button"
              role="switch"
              [attr.aria-checked]="enableReverse()"
              class="relative inline-flex h-6 w-11 shrink-0 items-center rounded-full transition-colors"
              [class]="enableReverse() ? 'bg-primary' : 'bg-slate-300 dark:bg-slate-600'"
              (click)="onToggleEnableReverse()"
              data-testid="deck-settings-enable-reverse"
            >
              <span
                class="inline-block h-4 w-4 rounded-full bg-white transition-transform"
                [class]="enableReverse() ? 'translate-x-6' : 'translate-x-1'"
              ></span>
            </button>
          </div>
        </div>

        <!-- FSRS 演算法設定區塊 -->
        <div class="flex flex-col gap-4">
          <div class="flex items-center justify-between">
            <fm-section-heading text="FSRS 演算法"></fm-section-heading>
            <button
              type="button"
              class="text-xs text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300"
              (click)="onResetFsrsDefaults()"
              data-testid="fsrs-reset-defaults"
            >
              重置為預設值
            </button>
          </div>

          <fm-number-input-row
            [formControl]="requestRetentionControl"
            label="目標保留率"
            title="記憶保留"
            description="較高保留率會縮短複習間隔"
            icon="psychology"
            iconClass="bg-purple-500/10 text-purple-500"
            [min]="0.70"
            [max]="0.97"
            [step]="0.01"
            ariaLabel="目標保留率"
            data-testid="fsrs-request-retention"
          ></fm-number-input-row>

          <fm-number-input-row
            [formControl]="maximumIntervalControl"
            label="最大複習間隔"
            title="間隔上限"
            description="複習間隔不超過此天數"
            icon="date_range"
            iconClass="bg-teal-500/10 text-teal-500"
            [min]="30"
            [max]="36500"
            [step]="30"
            unit="天"
            inputWidth="w-20"
            ariaLabel="最大複習間隔"
            data-testid="fsrs-maximum-interval"
          ></fm-number-input-row>

          <fm-labeled-input
            [formControl]="learningStepsControl"
            label="學習步驟"
            icon="stairs"
            placeholder="1m, 10m"
            ariaLabel="學習步驟"
            data-testid="fsrs-learning-steps"
          ></fm-labeled-input>
          @if (learningStepsControl.errors?.['invalidLearningSteps']) {
            <p class="text-xs text-red-500 -mt-4">格式不正確，範例：1m, 10m, 1h</p>
          }

          <fm-labeled-input
            [formControl]="relearningStepsControl"
            label="重學步驟"
            icon="replay"
            placeholder="10m"
            ariaLabel="重學步驟"
            data-testid="fsrs-relearning-steps"
          ></fm-labeled-input>
          @if (relearningStepsControl.errors?.['invalidLearningSteps']) {
            <p class="text-xs text-red-500 -mt-4">格式不正確，範例：10m 或 5m, 10m</p>
          }
        </div>

        <p class="text-xs leading-relaxed text-slate-400 dark:text-slate-500">
          進階提示：修改 FSRS 參數不會影響已排程的卡片，僅對後續的複習排程生效。
        </p>

        @if (errorMessage()) {
          <p class="text-sm text-red-500">{{ errorMessage() }}</p>
        }
      </form>

      <div class="mt-8 border-t border-slate-200 pt-6 dark:border-slate-700">
        <fm-section-heading text="危險區域"></fm-section-heading>
        <p class="mb-4 text-sm text-slate-500 dark:text-slate-400">
          刪除牌組將同時刪除所有卡片與學習紀錄，此操作無法復原。
        </p>
        <fm-button
          variant="ghost"
          [fullWidth]="true"
          [disabled]="isDeleting()"
          (click)="onDelete()"
        >
          <span class="text-red-500">{{ isDeleting() ? '刪除中...' : '刪除牌組' }}</span>
        </fm-button>
      </div>
    }
  </main>

  @if (!isLoading()) {
    <div class="mt-auto p-4 pt-2">
      <div class="flex flex-col gap-3">
        <fm-button
          [fullWidth]="true"
          [disabled]="isSubmitting()"
          (click)="onSave()"
        >
          {{ isSubmitting() ? '儲存中...' : '儲存設定' }}
        </fm-button>
        <fm-button
          variant="ghost"
          [fullWidth]="true"
          [disabled]="isSubmitting()"
          (click)="onCancel()"
        >
          取消
        </fm-button>
      </div>
    </div>
  }
</div>
