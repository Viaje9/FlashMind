<div class="flex flex-col">
  <div class="fixed top-0 left-0 right-0 z-30 bg-background-light dark:bg-background-dark">
    <fm-page-header [title]="deckName()" layout="center" [sticky]="false">
      <fm-icon-button class="fm-header-left" variant="ghost" ariaLabel="返回" (click)="onBackToDeck()">
        <span class="material-symbols-outlined text-[22px]">arrow_back_ios_new</span>
      </fm-icon-button>
      @if (canUndo()) {
        <fm-icon-button class="fm-header-right" variant="ghost" ariaLabel="返回上一張" (click)="onUndo()">
          <span class="material-symbols-outlined text-[22px]">undo</span>
        </fm-icon-button>
      }
    </fm-page-header>
    @if (isStudying()) {
      <div class="mx-auto w-full max-w-md">
        <fm-study-progress [current]="progress().current" [total]="progress().total"></fm-study-progress>
      </div>
    }
  </div>
  <div class="shrink-0 h-[calc(env(safe-area-inset-top,0px)+7.25rem)]"></div>

  @if (isLoading()) {
    <div class="flex-1 flex items-center justify-center">
      <div class="text-center">
        <span class="material-symbols-outlined text-4xl animate-spin text-primary">progress_activity</span>
        <p class="mt-4 text-base-content/60">載入學習卡片中...</p>
      </div>
    </div>
  } @else if (hasError()) {
    <div class="flex-1 flex items-center justify-center">
      <div class="text-center">
        <span class="material-symbols-outlined text-4xl text-error">error</span>
        <p class="mt-4 text-error">{{ studyStore.error() }}</p>
        <button class="btn btn-primary mt-4" (click)="onBackToDeck()">返回牌組</button>
      </div>
    </div>
  } @else if (isCompleted()) {
    <div class="flex-1 flex items-center justify-center px-4">
      <div class="text-center w-full max-w-sm">
        <span class="material-symbols-outlined text-6xl text-primary">celebration</span>
        <h2 class="text-2xl font-bold mt-4">學習完成！</h2>
        <div class="stats stats-vertical shadow mt-6 w-full">
          <div class="stat">
            <div class="stat-title">總學習</div>
            <div class="stat-value text-primary">{{ stats().totalStudied }}</div>
          </div>
          <div class="stat">
            <div class="stat-figure text-success">
              <span class="material-symbols-outlined text-3xl">check_circle</span>
            </div>
            <div class="stat-title">知道</div>
            <div class="stat-value text-success">{{ stats().knownCount }}</div>
          </div>
          <div class="stat">
            <div class="stat-figure text-warning">
              <span class="material-symbols-outlined text-3xl">help</span>
            </div>
            <div class="stat-title">不熟</div>
            <div class="stat-value text-warning">{{ stats().unfamiliarCount }}</div>
          </div>
          <div class="stat">
            <div class="stat-figure text-error">
              <span class="material-symbols-outlined text-3xl">cancel</span>
            </div>
            <div class="stat-title">不知道</div>
            <div class="stat-value text-error">{{ stats().unknownCount }}</div>
          </div>
        </div>
        <div class="flex gap-4 mt-6">
          <button class="btn btn-outline flex-1" (click)="onBackToDeck()">返回牌組</button>
          <button class="btn btn-primary flex-1" (click)="onStudyAgain()">再學一次</button>
        </div>
      </div>
    </div>
  } @else if (isStudying()) {
    @if (currentCard(); as card) {
      @if (isFlipped()) {
        <!-- 翻牌後：可滑動的卡片 -->
        <fm-swipeable-card
          class="mx-auto w-full max-w-md flex-1 flex flex-col px-4 py-4"
          (swipeComplete)="onRating($event)"
        >
          <div class="flex-1" data-testid="study-card-container">
            <fm-study-card
              [word]="word()"
              [translations]="translations()"
              [examples]="examples()"
              [wordAudioLoading]="wordAudioLoading()"
              [exampleAudioLoadingIndex]="exampleAudioLoadingIndex()"
              (audioClick)="onAudioClick()"
              (exampleAudioClick)="onExampleAudioClick($event)"
            ></fm-study-card>
          </div>
        </fm-swipeable-card>
      } @else {
        <!-- 正面：只顯示單字 -->
        <main
          class="mx-auto w-full max-w-md min-h-[calc(100dvh-env(safe-area-inset-top,0px)-7.25rem)] flex flex-col items-center justify-center px-4 py-4"
          data-testid="study-card-container"
          [class.cursor-pointer]="!isSubmitting()"
          (click)="onCardClick()"
        >
          <div class="card bg-gradient-to-br from-primary/5 to-primary/10 border-2 border-primary/20 shadow-lg w-full study-front-card">
            <div class="card-body items-center text-center py-16">
              @if (isSubmitting()) {
                <span class="material-symbols-outlined text-4xl animate-spin text-primary">progress_activity</span>
              } @else {
                @if (isReverse()) {
                  <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-700 dark:bg-purple-900/40 dark:text-purple-300 mb-3" data-testid="study-reverse-badge">
                    <span class="material-symbols-outlined text-[14px]">swap_horiz</span>
                    反向卡
                  </span>
                }
                <h2 class="card-title text-4xl font-bold text-slate-800 dark:text-white">{{ word() }}</h2>
                <p class="text-primary/70 mt-4 font-medium">點擊查看答案</p>
              }
            </div>
          </div>
        </main>
      }
    }
  }
</div>
